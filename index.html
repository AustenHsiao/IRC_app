<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>IRC: CS594</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div id="displayArea1" style="display:block">
        <div style="display:inline">Current username:</div>
        <div id=usernameDisplay style="display:inline"></div>
    </div>
    <div id='displayArea2' style="display:block">
        <div style="display:inline">Current chatroom:</div>
        <div id=chatroomDisplay style="display:inline"></div>
    </div>

    <form id='signin'>
        <label for='username'>Username:</label>
        <input type='text' id='ign' name='ign' placeholder='Username' required></input>
        <br>
        <label for='chatroom'>Chatroom:</label>
        <input type='text' id='chatroom' name='chatroom' placeholder='Enter chatroom' required></input>
        <br>
        <button type="submit">Set</button>
    </form>

    <ul id='openChatrooms'></ul>

    <div id="chatbox" style="width:40vw;height:20vw;;resize:none;border-style:solid;position:relative;bottom:0;">
        <div id='msgdisplay' style="width:100%; height:90%;padding-left: 1vw;"></div>
        <form style="position:relative;" id='chatform' style='width:100%;height:10%;'>
            <label for='text'>Enter Message:</label>
            <input type='text' id='chatinput'></input>
            <button>Send</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const chat = document.getElementById('chatform');
        const unameForm = document.getElementById('signin');
        const input = document.getElementById('chatinput');
        var uname = null;
        var rname = null;

        function nonEmpty(){
            if (!uname || !rname) {
                alert("Username and chatroom cannot be empty. Please set these values.");
                return 0;
            }
            return 1;
        }

        unameForm.addEventListener('submit', event => {
            event.preventDefault();
            uname = document.getElementById('ign').value;
            rname = document.getElementById('chatroom').value;

            if(nonEmpty() === 0){
                return;
            }
            var oldName = document.getElementById("usernameDisplay").innerText;
            var oldRoom = document.getElementById("chatroomDisplay").innerText;
            socket.emit('urChange', {'uname':uname, 'rname':rname, 'oldName': oldName, 'oldRoom': oldRoom});
        });

        socket.on('urResponse', data => {
            if(data == 0){
                //name taken
                alert("Somebody else has this username. Enter a different username");
                return;
            }
            document.getElementById("usernameDisplay").innerText = uname;
            document.getElementById("chatroomDisplay").innerText = rname;
        });

        chat.addEventListener('submit', event => {
            /*
                When a user sends a message, the server needs it
            */
            event.preventDefault()
            if(nonEmpty() === 0){
                return 0;
            }

            var msg = input.value;
            socket.emit('sendMsg', {'room':rname, 'uname':uname, 'message':msg});
            input.value = '';
        });

        socket.on('chat', contents => {
            document.getElementById("msgdisplay").innerText += contents.uname + ': ' + contents.message + '\n';
        });

    </script>
</body>

</html>